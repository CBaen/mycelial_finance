# dashboard.py - MYCELIAL INTELLIGENCE v10.0: BIG ROCK 25 - Real Data & Pattern Discovery
# Mission: ALL data is real, Pattern Discovery tab, Agent card carousel

import dash
from dash import dcc, html, Input, Output, State
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import logging
import time
import json
import threading
from queue import Queue
import math
import dash_bootstrap_components as dbc
import uuid
import numpy as np
from datetime import datetime

from src.connectors.redis_client import RedisClient

# === SETUP ===
log = logging.getLogger('werkzeug')
log.setLevel(logging.ERROR)

message_queue = Queue()
SESSION_ID = str(uuid.uuid4())[:8]

# Professional color palette
COLORS = {
    'primary': '#a855f7',
    'success': '#10b981',
    'warning': '#f59e0b',
    'danger': '#ef4444',
    'info': '#3b82f6',
    'corp': '#FF5733',
    'background': '#0f1419',
    'card': '#1a202c',
    'text': '#e2e8f0',
    'text_muted': '#9ca3af',
    'border': '#2d3748',
}

# === INTERESTINGNESS FORMULA (All components use REAL data) ===
def calculate_interestingness(agent_data, all_agents):
    """5-Component Interestingness Score using REAL data only."""
    score = 0

    def get_normalized_vector(data):
        vec = np.array(data.get('vector', [0, 0, 0, 0]))
        if vec.ndim == 1 and len(vec) < 4:
            vec = np.pad(vec, (0, 4 - len(vec)), mode='constant')
        return vec / np.linalg.norm(vec) if np.linalg.norm(vec) > 0 else np.zeros(4)

    # 1. Novelty (20pts) - based on real parent difference
    parent_id = agent_data.get('parent')
    if parent_id and parent_id != 'Genesis' and parent_id in all_agents:
        parent_vec = get_normalized_vector(all_agents[parent_id])
        current_vec = get_normalized_vector(agent_data)
        novelty = np.linalg.norm(current_vec - parent_vec)
        score += min(novelty * 10, 20)
    else:
        score += 10

    # 2. Performance (20pts) - based on real patterns discovered
    patterns = agent_data.get('patterns_discovered', 0)
    performance = min(patterns / 10.0, 1.0)  # Normalize to 0-1
    score += performance * 20

    # 3. Diversity (20pts) - based on real vector distances
    if all_agents:
        my_vec = get_normalized_vector(agent_data)
        distances = []
        for a_id, a_data in all_agents.items():
            if a_id != agent_data.get('id', ''):
                distances.append(np.linalg.norm(my_vec - get_normalized_vector(a_data)))
        avg_distance = np.mean(distances) if distances else 0
        score += min(avg_distance * 8, 20)

    # 4. Evolution (20pts) - based on real generation
    generation = agent_data.get('generation', 0)
    score += min(generation * 2, 20)

    # 5. Growth Bonus (20pts) - based on REAL policy shares
    policy_shares = agent_data.get('policy_shares', 0)
    share_frequency = min(policy_shares / 20.0, 1.0)  # Normalize
    score += share_frequency * 20

    return min(score, 100)

# === AGENT METADATA ===
AGENT_INFO = {
    'DataMiner_XXBTZUSD_1': {'name': 'BTC Sensor', 'type': 'Data Miner', 'color': COLORS['primary'], 'product': 'Finance', 'icon': 'fa-bitcoin'},
    'DataMiner_XETHZUSD_2': {'name': 'ETH Sensor', 'type': 'Data Miner', 'color': COLORS['primary'], 'product': 'Finance', 'icon': 'fa-ethereum'},
    'RepoScraper_3': {'name': 'Code Hunter', 'type': 'Data Miner', 'color': COLORS['success'], 'product': 'Code Innovation', 'icon': 'fa-code'},
    'LogisticsMiner_4': {'name': 'Flow Tracker', 'type': 'Data Miner', 'color': COLORS['warning'], 'product': 'Logistics', 'icon': 'fa-truck'},
    'GovtDataMiner_5': {'name': 'Policy Scout', 'type': 'Data Miner', 'color': COLORS['info'], 'product': 'Government', 'icon': 'fa-landmark'},
    'CorpDataMiner_6': {'name': 'Corp Intel', 'type': 'Data Miner', 'color': COLORS['corp'], 'product': 'US Corporations', 'icon': 'fa-building'},
    'Trader_107': {'name': 'Trade Executor', 'type': 'Action Agent', 'color': '#fbbf24', 'product': 'System', 'icon': 'fa-bolt'},
    'RiskManager_108': {'name': 'Safety Monitor', 'type': 'HAVEN Guardian', 'color': COLORS['danger'], 'product': 'System', 'icon': 'fa-shield-alt'},
    'AutonomousBuilder_109': {'name': 'Builder', 'type': 'Evolution Engine', 'color': '#9333ea', 'product': 'System', 'icon': 'fa-cogs'},
}

for i in range(7, 107):
    products = ['Finance', 'Code Innovation', 'Logistics', 'Government', 'US Corporations']
    product = products[i % 5]
    AGENT_INFO[f'SwarmBrain_{i}'] = {
        'name': f'Brain {i}',
        'type': 'Pattern Learner',
        'color': COLORS['primary'],
        'product': product,
        'icon': 'fa-brain'
    }

# === DASH APP ===
app = dash.Dash(
    __name__,
    external_stylesheets=[
        dbc.themes.SLATE,
        "https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap",
        "https://use.fontawesome.com/releases/v6.5.1/css/all.css"
    ],
    suppress_callback_exceptions=True,
)
app.title = "Mycelial Intelligence - v10.0 Real Data Engine"

# === LAYOUT ===
app.layout = dbc.Container(
    fluid=True,
    className="p-4",
    style={'backgroundColor': COLORS['background'], 'minHeight': '100vh', 'fontFamily': "'Inter', sans-serif"},
    children=[
        # Data stores
        dcc.Store(id='pattern-store', data={'total_patterns': 0, 'times': [], 'counts': []}),
        dcc.Store(id='moat-health-store', data={'Finance': 100, 'Code Innovation': 100, 'Logistics': 100, 'Government': 100, 'US Corporations': 100}),
        dcc.Store(id='activity-log-store', data=[]),
        dcc.Store(id='agent-stats-store', data={}),
        dcc.Store(id='discoveries-store', data=[]),
        dcc.Store(id='swarm-health-store', data={'value': 100, 'history': [100]}),
        dcc.Store(id='pattern-details-store', data=[]),  # NEW: Track individual patterns
        dcc.Store(id='moat-stats-store', data={  # NEW: Track real moat stats
            'Finance': {'patterns': 0, 'agents': set()},
            'Code Innovation': {'patterns': 0, 'agents': set()},
            'Logistics': {'patterns': 0, 'agents': set()},
            'Government': {'patterns': 0, 'agents': set()},
            'US Corporations': {'patterns': 0, 'agents': set()}
        }),
        dcc.Store(id='haven-risk-store', data={'current_risk': 15, 'history': [15]}),  # NEW: Track real HAVEN risk
        dcc.Store(id='agent-carousel-index', data=0),  # NEW: Track carousel position

        dcc.Interval(id='interval', interval=2000, n_intervals=0),

        # === HEADER ===
        dbc.Row(dbc.Col(html.Div([
            html.H1([
                html.I(className="fas fa-brain", style={'marginRight': '15px', 'color': COLORS['primary']}),
                "MYCELIAL INTELLIGENCE ENGINE"
            ], style={'fontSize': '2.5rem', 'fontWeight': '700', 'color': COLORS['text'], 'textAlign': 'center'}),
            html.P("v10.0: Big Rock 25 - Real Data & Pattern Discovery",
                  style={'color': COLORS['text_muted'], 'fontSize': '0.95rem', 'textAlign': 'center'}),
        ], className="py-3 mb-4"))),

        # === KEY METRICS ROW ===
        dbc.Row([
            dbc.Col([
                dbc.Card([
                    dbc.CardBody([
                        html.Div([
                            html.I(className="fas fa-lightbulb fa-2x", style={'color': COLORS['warning']}),
                            dbc.Tooltip(
                                "Total unique patterns discovered by your 100-agent swarm across all 5 product moats. "
                                "This is your cumulative intelligence growth metric.",
                                target="patterns-discovered-card",
                            ),
                        ], style={'float': 'right'}),
                        html.H6("Patterns Discovered", style={'color': COLORS['text_muted'], 'marginBottom': '10px'}),
                        html.H2(id='total-patterns-metric', children="0", style={'color': COLORS['warning'], 'fontWeight': '700'}),
                        html.P(id='patterns-growth-text', children="+0 this session", style={'color': COLORS['success'], 'fontSize': '0.9rem'}),
                    ])
                ], style={'backgroundColor': COLORS['card'], 'borderLeft': f'4px solid {COLORS["warning"]}'}, id="patterns-discovered-card"),
            ], width=3),

            dbc.Col([
                dbc.Card([
                    dbc.CardBody([
                        html.Div([
                            html.I(className="fas fa-heartbeat fa-2x", style={'color': COLORS['success']}),
                            dbc.Tooltip(
                                "Overall health of your swarm (0-100). Calculated from average moat health across all 5 pillars.",
                                target="swarm-health-card",
                            ),
                        ], style={'float': 'right'}),
                        html.H6("Swarm Health", style={'color': COLORS['text_muted'], 'marginBottom': '10px'}),
                        html.H2(id='swarm-health-metric', children="100", style={'color': COLORS['success'], 'fontWeight': '700'}),
                        html.P(id='swarm-health-status', children="Excellent", style={'color': COLORS['success'], 'fontSize': '0.9rem'}),
                    ])
                ], style={'backgroundColor': COLORS['card'], 'borderLeft': f'4px solid {COLORS["success"]}'}, id="swarm-health-card"),
            ], width=3),

            dbc.Col([
                dbc.Card([
                    dbc.CardBody([
                        html.Div([
                            html.I(className="fas fa-network-wired fa-2x", style={'color': COLORS['info']}),
                            dbc.Tooltip(
                                "Number of active agents that have published data this session.",
                                target="active-agents-card",
                            ),
                        ], style={'float': 'right'}),
                        html.H6("Active Agents", style={'color': COLORS['text_muted'], 'marginBottom': '10px'}),
                        html.H2(id='active-agents-metric', children="0", style={'color': COLORS['info'], 'fontWeight': '700'}),
                        html.P("Across 5 Product Moats", style={'color': COLORS['text_muted'], 'fontSize': '0.9rem'}),
                    ])
                ], style={'backgroundColor': COLORS['card'], 'borderLeft': f'4px solid {COLORS["info"]}'}, id="active-agents-card"),
            ], width=3),

            dbc.Col([
                dbc.Card([
                    dbc.CardBody([
                        html.Div([
                            html.I(className="fas fa-fire fa-2x", style={'color': COLORS['danger']}),
                            dbc.Tooltip(
                                "HAVEN Risk Framework: System risk level (0-100). Calculated from actual system messages. "
                                "85+ triggers policy contagion blocks.",
                                target="haven-risk-card",
                            ),
                        ], style={'float': 'right'}),
                        html.H6("HAVEN Risk Level", style={'color': COLORS['text_muted'], 'marginBottom': '10px'}),
                        html.H2(id='haven-risk-metric', children="LOW", style={'color': COLORS['success'], 'fontWeight': '700'}),
                        html.P(id='haven-risk-value', children="15%", style={'color': COLORS['text_muted'], 'fontSize': '0.9rem'}),
                    ])
                ], style={'backgroundColor': COLORS['card'], 'borderLeft': f'4px solid {COLORS["danger"]}'}, id="haven-risk-card"),
            ], width=3),
        ], className='mb-4'),

        # === TABS ===
        dbc.Tabs(id="tabs", active_tab="tab-pattern-discovery", className="mb-4", children=[
            dbc.Tab(label="ðŸ” Pattern Discovery", tab_id="tab-pattern-discovery",
                   label_style={'color': COLORS['text_muted']}, active_label_style={'color': COLORS['primary'], 'fontWeight': '600'}),
            dbc.Tab(label="ðŸ§  Agent Activity", tab_id="tab-agent-activity",
                   label_style={'color': COLORS['text_muted']}, active_label_style={'color': COLORS['primary'], 'fontWeight': '600'}),
            dbc.Tab(label="ðŸ° 5-Pillar Moats", tab_id="tab-moats",
                   label_style={'color': COLORS['text_muted']}, active_label_style={'color': COLORS['primary'], 'fontWeight': '600'}),
            dbc.Tab(label="ðŸŽ´ Agent Cards", tab_id="tab-agent-cards",
                   label_style={'color': COLORS['text_muted']}, active_label_style={'color': COLORS['primary'], 'fontWeight': '600'}),
            dbc.Tab(label="ðŸ“Š Growth Analytics", tab_id="tab-analytics",
                   label_style={'color': COLORS['text_muted']}, active_label_style={'color': COLORS['primary'], 'fontWeight': '600'}),
        ]),
        html.Div(id="tab-content"),

        html.Div(f"Session {SESSION_ID} | Big Rock 25: Real Data Engine | All Data is Live",
                className="text-center mt-4", style={'color': COLORS['text_muted'], 'fontSize': '0.75rem'})
    ]
)

# === REDIS LISTENER ===
def start_redis_listener(app_queue: Queue):
    logging.info("v10.0 Real Data Engine: Redis listener started")
    try:
        redis_client = RedisClient()
    except Exception as e:
        logging.critical(f"Redis error: {e}")
        return
    if not redis_client.connection:
        return

    channels = {
        'market-data:*': 'market-data',
        'trade-orders': 'trade-order',
        'trade-confirmations': 'trade-confirmation',
        'system-control': 'system-control',
        'system-build-request': 'build-request',
        'policy-data:*': 'policy-data',
        'corporate-data:*': 'corporate-data',
        'repo-data:*': 'repo-data',
        'logistics-data:*': 'logistics-data',
        'agent-lineage-update': 'lineage-update',
        'govt-data:*': 'govt-data'
    }

    def create_listener(pattern, msg_type):
        r = RedisClient()
        if not r.connection:
            return
        pubsub = r.connection.pubsub(ignore_subscribe_messages=True)
        try:
            pubsub.psubscribe(pattern)
            for message in pubsub.listen():
                try:
                    data = json.loads(message['data'])
                    app_queue.put({'type': msg_type, 'data': data, 'channel': message['channel'], 'time': time.time()})
                except:
                    pass
        except:
            pass
        finally:
            pubsub.close()

    for pattern, msg_type in channels.items():
        t = threading.Thread(target=create_listener, args=(pattern, msg_type), daemon=True)
        t.start()

listener_thread = threading.Thread(target=start_redis_listener, args=(message_queue,), daemon=True)
listener_thread.start()
logging.info("Mycelial Real Data Engine v10.0 Active")

# === MAIN DATA UPDATE ===
@app.callback(
    [Output('pattern-store', 'data'),
     Output('moat-health-store', 'data'),
     Output('activity-log-store', 'data'),
     Output('agent-stats-store', 'data'),
     Output('swarm-health-store', 'data'),
     Output('discoveries-store', 'data'),
     Output('pattern-details-store', 'data'),
     Output('moat-stats-store', 'data'),
     Output('haven-risk-store', 'data')],
    [Input('interval', 'n_intervals')],
    [State('pattern-store', 'data'),
     State('moat-health-store', 'data'),
     State('activity-log-store', 'data'),
     State('agent-stats-store', 'data'),
     State('swarm-health-store', 'data'),
     State('discoveries-store', 'data'),
     State('pattern-details-store', 'data'),
     State('moat-stats-store', 'data'),
     State('haven-risk-store', 'data')]
)
def update_data(n, pattern_data, moat_health, activity_log, agent_stats, swarm_health, discoveries, pattern_details, moat_stats, haven_risk):
    """Process Redis messages and update all stores with REAL data only."""

    # Process all queued messages
    while not message_queue.empty():
        msg = message_queue.get()
        msg_type = msg['type']
        data = msg['data']
        timestamp = datetime.now().strftime('%H:%M:%S')

        source = data.get('source', 'Unknown')

        # Initialize agent stats if not exists
        if source and source != 'Unknown':
            if source not in agent_stats:
                agent_stats[source] = {
                    'patterns_discovered': 0,
                    'policy_shares': 0,
                    'last_active': timestamp,
                    'generation': 0,
                    'parent': 'Genesis',
                    'children': [],
                    'status': 'Active',
                    'vector': [0.0, 0.0, 0.0, 0.0],
                    'id': source
                }
            agent_stats[source]['last_active'] = timestamp

        # Track patterns by type with full metadata
        if msg_type == 'market-data':
            pair = data.get('pair', 'Unknown')
            moat = 'Finance'

            # Extract pattern signature from data
            features = data.get('features', {})
            pattern_signature = f"{pair} | Close: {features.get('close', 'N/A'):.2f} | RSI: {features.get('RSI', 'N/A'):.1f}"

            # Record detailed pattern
            pattern_record = {
                'time': timestamp,
                'moat': moat,
                'pattern': pattern_signature,
                'agents': [source],
                'type': 'Market Analysis'
            }
            pattern_details.append(pattern_record)

            activity_log.append({
                'time': timestamp,
                'agent': source,
                'action': f'ðŸ“Š {pair} Pattern Detected',
                'color': COLORS['primary']
            })
            pattern_data['total_patterns'] += 1
            moat_health[moat] = min(100, moat_health.get(moat, 100) + 0.5)

            # Track moat stats
            if isinstance(moat_stats[moat]['agents'], set):
                moat_stats[moat]['agents'].add(source)
            else:
                moat_stats[moat]['agents'] = {source}
            moat_stats[moat]['patterns'] = moat_stats[moat].get('patterns', 0) + 1

            if source and source != 'Unknown':
                agent_stats[source]['patterns_discovered'] += 1
                agent_stats[source]['policy_shares'] += 1

        elif msg_type == 'repo-data':
            moat = 'Code Innovation'
            features = data.get('features', {})
            pattern_signature = f"Code: Stars {features.get('StarVelocity', 0):.0f} | Forks {features.get('ForkVelocity', 0):.0f}"

            pattern_record = {
                'time': timestamp,
                'moat': moat,
                'pattern': pattern_signature,
                'agents': [source],
                'type': 'Code Discovery'
            }
            pattern_details.append(pattern_record)

            activity_log.append({
                'time': timestamp,
                'agent': source,
                'action': f'ðŸ’¡ Code Innovation Pattern',
                'color': COLORS['success']
            })
            pattern_data['total_patterns'] += 1
            moat_health[moat] = min(100, moat_health.get(moat, 100) + 0.5)

            if isinstance(moat_stats[moat]['agents'], set):
                moat_stats[moat]['agents'].add(source)
            else:
                moat_stats[moat]['agents'] = {source}
            moat_stats[moat]['patterns'] = moat_stats[moat].get('patterns', 0) + 1

            if source and source != 'Unknown':
                agent_stats[source]['patterns_discovered'] += 1
                agent_stats[source]['policy_shares'] += 1

        elif msg_type == 'logistics-data':
            moat = 'Logistics'
            features = data.get('features', {})
            pattern_signature = f"Logistics: Efficiency {features.get('RouteEfficiency', 0):.1f} | Velocity {features.get('CargoVelocity', 0):.1f}"

            pattern_record = {
                'time': timestamp,
                'moat': moat,
                'pattern': pattern_signature,
                'agents': [source],
                'type': 'Logistics Flow'
            }
            pattern_details.append(pattern_record)

            activity_log.append({
                'time': timestamp,
                'agent': source,
                'action': f'ðŸšš Logistics Flow Pattern',
                'color': COLORS['warning']
            })
            pattern_data['total_patterns'] += 1
            moat_health[moat] = min(100, moat_health.get(moat, 100) + 0.5)

            if isinstance(moat_stats[moat]['agents'], set):
                moat_stats[moat]['agents'].add(source)
            else:
                moat_stats[moat]['agents'] = {source}
            moat_stats[moat]['patterns'] = moat_stats[moat].get('patterns', 0) + 1

            if source and source != 'Unknown':
                agent_stats[source]['patterns_discovered'] += 1
                agent_stats[source]['policy_shares'] += 1

        elif msg_type == 'govt-data' or msg_type == 'policy-data':
            moat = 'Government'
            features = data.get('features', {})
            pattern_signature = f"Policy: Intensity {features.get('RegulatoryIntensity', 0):.1f} | Stability {features.get('PolicyStability', 0):.1f}"

            pattern_record = {
                'time': timestamp,
                'moat': moat,
                'pattern': pattern_signature,
                'agents': [source],
                'type': 'Policy Shift'
            }
            pattern_details.append(pattern_record)

            activity_log.append({
                'time': timestamp,
                'agent': source,
                'action': f'ðŸ›ï¸ Policy Pattern Detected',
                'color': COLORS['info']
            })
            pattern_data['total_patterns'] += 1
            moat_health[moat] = min(100, moat_health.get(moat, 100) + 0.5)

            if isinstance(moat_stats[moat]['agents'], set):
                moat_stats[moat]['agents'].add(source)
            else:
                moat_stats[moat]['agents'] = {source}
            moat_stats[moat]['patterns'] = moat_stats[moat].get('patterns', 0) + 1

            if source and source != 'Unknown':
                agent_stats[source]['patterns_discovered'] += 1
                agent_stats[source]['policy_shares'] += 1

        elif msg_type == 'corporate-data':
            moat = 'US Corporations'
            features = data.get('features', {})
            pattern_signature = f"Corp: Earnings {features.get('EarningsMomentum', 0):.1f} | M&A {features.get('MandA_Activity', 0):.1f}"

            pattern_record = {
                'time': timestamp,
                'moat': moat,
                'pattern': pattern_signature,
                'agents': [source],
                'type': 'Corporate Intel'
            }
            pattern_details.append(pattern_record)

            activity_log.append({
                'time': timestamp,
                'agent': source,
                'action': f'ðŸ¢ Corporate Intel Pattern',
                'color': COLORS['corp']
            })
            pattern_data['total_patterns'] += 1
            moat_health[moat] = min(100, moat_health.get(moat, 100) + 0.5)

            if isinstance(moat_stats[moat]['agents'], set):
                moat_stats[moat]['agents'].add(source)
            else:
                moat_stats[moat]['agents'] = {source}
            moat_stats[moat]['patterns'] = moat_stats[moat].get('patterns', 0) + 1

            if source and source != 'Unknown':
                agent_stats[source]['patterns_discovered'] += 1
                agent_stats[source]['policy_shares'] += 1

        elif msg_type == 'build-request':
            requester = data.get('requester', 'Unknown')
            agent_type = data.get('agent_type', 'Unknown')
            reason = data.get('reason', 'Unknown')
            activity_log.append({
                'time': timestamp,
                'agent': requester,
                'action': f'ðŸ”§ Requested {agent_type}: {reason}',
                'color': '#9333ea'
            })
            discoveries.append({
                'time': timestamp,
                'type': 'Evolution',
                'description': f'{requester} requested {agent_type}',
                'importance': 'High'
            })

        elif msg_type == 'system-control':
            # Track REAL HAVEN risk from system control messages
            risk_level = data.get('risk_level', haven_risk['current_risk'])
            haven_risk['current_risk'] = risk_level
            haven_risk['history'].append(risk_level)
            if len(haven_risk['history']) > 50:
                haven_risk['history'] = haven_risk['history'][-50:]

        # Track pattern discoveries over time
        pattern_data['times'].append(timestamp)
        pattern_data['counts'].append(pattern_data['total_patterns'])
        if len(pattern_data['times']) > 50:
            pattern_data['times'] = pattern_data['times'][-50:]
            pattern_data['counts'] = pattern_data['counts'][-50:]

    # Limit sizes
    if len(activity_log) > 100:
        activity_log = activity_log[-100:]
    if len(pattern_details) > 500:
        pattern_details = pattern_details[-500:]

    # Calculate swarm health from moat health
    avg_moat_health = sum(moat_health.values()) / len(moat_health)
    swarm_health['value'] = avg_moat_health
    swarm_health['history'].append(avg_moat_health)
    if len(swarm_health['history']) > 50:
        swarm_health['history'] = swarm_health['history'][-50:]

    return pattern_data, moat_health, activity_log, agent_stats, swarm_health, discoveries, pattern_details, moat_stats, haven_risk

# === KEY METRICS UPDATES ===
@app.callback(
    [Output('total-patterns-metric', 'children'),
     Output('patterns-growth-text', 'children'),
     Output('swarm-health-metric', 'children'),
     Output('swarm-health-status', 'children'),
     Output('haven-risk-metric', 'children'),
     Output('haven-risk-value', 'children'),
     Output('active-agents-metric', 'children')],
    [Input('pattern-store', 'data'),
     Input('swarm-health-store', 'data'),
     Input('haven-risk-store', 'data'),
     Input('agent-stats-store', 'data')]
)
def update_key_metrics(pattern_data, swarm_health, haven_risk, agent_stats):
    total = pattern_data['total_patterns']
    growth_text = f"+{total} this session"

    health_val = swarm_health['value']
    health_display = f"{health_val:.0f}"
    if health_val >= 90:
        health_status = "Excellent"
        health_color = COLORS['success']
    elif health_val >= 70:
        health_status = "Good"
        health_color = COLORS['info']
    else:
        health_status = "Needs Attention"
        health_color = COLORS['warning']

    # Use REAL HAVEN risk from store
    risk = haven_risk['current_risk']
    if risk < 50:
        risk_level = "LOW"
        risk_color = COLORS['success']
    elif risk < 85:
        risk_level = "MEDIUM"
        risk_color = COLORS['warning']
    else:
        risk_level = "HIGH"
        risk_color = COLORS['danger']

    # Count active agents (agents with data)
    active_count = len(agent_stats)

    return (
        f"{total:,}",
        growth_text,
        health_display,
        html.Span(health_status, style={'color': health_color}),
        html.Span(risk_level, style={'color': risk_color}),
        f"{risk:.0f}%",
        str(active_count)
    )

# === TAB RENDERER ===
@app.callback(
    Output('tab-content', 'children'),
    [Input('tabs', 'active_tab')]
)
def render_tab_content(active_tab):

    if active_tab == 'tab-pattern-discovery':
        return dbc.Container(fluid=True, children=[
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸ” Pattern Discovery Dashboard", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            html.Div(id='pattern-headlines')
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=12),
            ]),
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸ“‹ Detailed Pattern Catalog", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            html.Div(id='pattern-catalog', style={
                                'maxHeight': '500px',
                                'overflowY': 'scroll'
                            })
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=12),
            ], className='mt-3'),
        ])

    elif active_tab == 'tab-agent-activity':
        return dbc.Container(fluid=True, children=[
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸ§  Agent Performance Leaderboard (Real Data)", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            dcc.Graph(id='agent-leaderboard'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=6),
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸ“¡ Agent Communication Network", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            dcc.Graph(id='agent-network'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=6),
            ]),
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸ“Š Agent Type Summary", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            html.Div(id='agent-type-summary')
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=12),
            ], className='mt-3'),
        ])

    elif active_tab == 'tab-moats':
        return dbc.Container(fluid=True, children=[
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸ° 5-Pillar Moat Health", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            dcc.Graph(id='moat-health-chart'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=12),
            ]),
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H6("ðŸ’° Finance Moat", style={'color': COLORS['primary']}),
                            html.Div(id='finance-moat-detail'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=4),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H6("ðŸ’» Code Innovation Moat", style={'color': COLORS['success']}),
                            html.Div(id='code-moat-detail'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=4),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H6("ðŸšš Logistics Moat", style={'color': COLORS['warning']}),
                            html.Div(id='logistics-moat-detail'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=4),
            ], className='mt-3'),
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H6("ðŸ›ï¸ Government Moat", style={'color': COLORS['info']}),
                            html.Div(id='govt-moat-detail'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=6),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H6("ðŸ¢ US Corporations Moat", style={'color': COLORS['corp']}),
                            html.Div(id='corp-moat-detail'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=6),
            ], className='mt-3'),
        ])

    elif active_tab == 'tab-agent-cards':
        return dbc.Container(fluid=True, children=[
            dbc.Row([
                dbc.Col([
                    html.H5("ðŸŽ´ Agent Card Browser", style={'color': COLORS['text'], 'marginBottom': '20px'}),
                    html.P("Browse through your agents like baseball cards. Use the navigation buttons to cycle through agents.",
                          style={'color': COLORS['text_muted']}),
                ], width=12),
            ]),
            dbc.Row([
                dbc.Col([
                    dbc.Button("â† Previous", id='prev-agent-btn', color='secondary', className='me-2'),
                    dbc.Button("Next â†’", id='next-agent-btn', color='secondary'),
                ], width=12, className='mb-3'),
            ]),
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody(id='agent-card-display')
                    ], style={'backgroundColor': COLORS['card']})
                ], width=12),
            ]),
        ])

    elif active_tab == 'tab-analytics':
        return dbc.Container(fluid=True, children=[
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸ“ˆ Swarm Health Over Time", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            dcc.Graph(id='swarm-health-chart'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=6),
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸŽ¯ Interestingness Distribution (Real)", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            dcc.Graph(id='interestingness-dist'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=6),
            ]),
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardHeader(html.H5("ðŸ“Š Pattern Discovery Timeline", style={'color': COLORS['text']})),
                        dbc.CardBody([
                            dcc.Graph(id='pattern-timeline'),
                        ])
                    ], style={'backgroundColor': COLORS['card']})
                ], width=12),
            ], className='mt-3'),
        ])

    return html.Div("Select a tab")

# === PATTERN HEADLINES ===
@app.callback(
    Output('pattern-headlines', 'children'),
    [Input('pattern-details-store', 'data')]
)
def update_pattern_headlines(pattern_details):
    if not pattern_details:
        return html.P("No patterns discovered yet...", style={'color': COLORS['text_muted']})

    # Get latest 5 patterns
    recent = pattern_details[-5:]

    headlines = []
    for p in reversed(recent):
        moat_color = {
            'Finance': COLORS['primary'],
            'Code Innovation': COLORS['success'],
            'Logistics': COLORS['warning'],
            'Government': COLORS['info'],
            'US Corporations': COLORS['corp']
        }.get(p['moat'], COLORS['text'])

        headlines.append(dbc.Alert([
            html.H6([
                html.I(className="fas fa-lightbulb", style={'marginRight': '10px', 'color': moat_color}),
                f"{p['type']} in {p['moat']}"
            ], style={'marginBottom': '10px'}),
            html.P(p['pattern'], style={'marginBottom': '5px'}),
            html.Small(f"Discovered by: {', '.join(p['agents'][:3])} | {p['time']}", style={'color': COLORS['text_muted']})
        ], color='dark', style={'marginBottom': '10px', 'borderLeft': f'4px solid {moat_color}'}))

    return headlines

# === PATTERN CATALOG ===
@app.callback(
    Output('pattern-catalog', 'children'),
    [Input('pattern-details-store', 'data')]
)
def update_pattern_catalog(pattern_details):
    if not pattern_details:
        return html.P("No patterns discovered yet...", style={'color': COLORS['text_muted']})

    # Group patterns by moat
    moat_groups = {}
    for p in pattern_details:
        moat = p['moat']
        if moat not in moat_groups:
            moat_groups[moat] = []
        moat_groups[moat].append(p)

    catalog = []
    for moat, patterns in moat_groups.items():
        moat_color = {
            'Finance': COLORS['primary'],
            'Code Innovation': COLORS['success'],
            'Logistics': COLORS['warning'],
            'Government': COLORS['info'],
            'US Corporations': COLORS['corp']
        }.get(moat, COLORS['text'])

        catalog.append(dbc.Card([
            dbc.CardHeader(html.H6(f"{moat} ({len(patterns)} patterns)", style={'color': moat_color})),
            dbc.CardBody([
                html.Div([
                    html.P([
                        html.Strong(f"[{p['time']}] ", style={'color': COLORS['text_muted']}),
                        html.Span(p['pattern'], style={'color': COLORS['text']}),
                        html.Br(),
                        html.Small(f"Agents: {', '.join(p['agents'][:5])}", style={'color': COLORS['text_muted']})
                    ], style={'marginBottom': '10px', 'paddingLeft': '10px', 'borderLeft': f'2px solid {moat_color}'})
                    for p in reversed(patterns[-20:])  # Show last 20 per moat
                ])
            ])
        ], style={'backgroundColor': COLORS['background'], 'marginBottom': '15px'}))

    return catalog

# === AGENT LEADERBOARD (REAL DATA) ===
@app.callback(
    Output('agent-leaderboard', 'figure'),
    [Input('agent-stats-store', 'data')]
)
def update_agent_leaderboard(agent_stats):
    if not agent_stats:
        return go.Figure()

    # Calculate real interestingness scores
    scores = []
    for agent_id, agent_data in agent_stats.items():
        if agent_id in AGENT_INFO:
            interest_score = calculate_interestingness(agent_data, agent_stats)
            scores.append((agent_id, interest_score))

    # Sort and take top 15
    scores.sort(key=lambda x: x[1], reverse=True)
    scores = scores[:15]

    if not scores:
        return go.Figure()

    fig = go.Figure()
    fig.add_trace(go.Bar(
        y=[AGENT_INFO[a[0]]['name'] for a in scores],
        x=[a[1] for a in scores],
        orientation='h',
        marker=dict(color=[a[1] for a in scores], colorscale='Purples', showscale=False),
        text=[f"{a[1]:.1f}" for a in scores],
        textposition='outside'
    ))

    fig.update_layout(
        title=dict(text="Top 15 Agents by Interestingness (Real Data)", font=dict(color=COLORS['text'], size=14)),
        plot_bgcolor=COLORS['card'],
        paper_bgcolor=COLORS['card'],
        font=dict(color=COLORS['text_muted']),
        xaxis=dict(title='Interestingness Score (0-100)', gridcolor=COLORS['border']),
        yaxis=dict(gridcolor=COLORS['border']),
        margin=dict(l=120, r=20, t=60, b=40),
        height=500
    )
    return fig

# === AGENT NETWORK ===
@app.callback(
    Output('agent-network', 'figure'),
    [Input('agent-stats-store', 'data')]
)
def update_agent_network(agent_stats):
    active_agents = list(agent_stats.keys())[:20]
    if not active_agents:
        return go.Figure()

    num_agents = len(active_agents)
    x_pos = [math.cos(2 * math.pi * i / num_agents) for i in range(num_agents)]
    y_pos = [math.sin(2 * math.pi * i / num_agents) for i in range(num_agents)]

    fig = go.Figure()

    # Add edges
    for i in range(num_agents - 1):
        fig.add_trace(go.Scatter(
            x=[x_pos[i], x_pos[i+1]],
            y=[y_pos[i], y_pos[i+1]],
            mode='lines',
            line=dict(color=COLORS['border'], width=1),
            showlegend=False,
            hoverinfo='none'
        ))

    # Add nodes
    fig.add_trace(go.Scatter(
        x=x_pos,
        y=y_pos,
        mode='markers+text',
        marker=dict(size=15, color=COLORS['primary'], line=dict(color=COLORS['text'], width=2)),
        text=[a.split('_')[-1][:3] for a in active_agents],
        textposition='top center',
        textfont=dict(color=COLORS['text'], size=9),
        hovertext=[AGENT_INFO.get(a, {'name': a})['name'] for a in active_agents],
        hoverinfo='text',
        showlegend=False
    ))

    fig.update_layout(
        title=dict(text="Active Agent Network", font=dict(color=COLORS['text'], size=14)),
        plot_bgcolor=COLORS['card'],
        paper_bgcolor=COLORS['card'],
        xaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
        yaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
        margin=dict(l=20, r=20, t=60, b=20),
        height=500
    )
    return fig

# === AGENT TYPE SUMMARY ===
@app.callback(
    Output('agent-type-summary', 'children'),
    [Input('agent-stats-store', 'data')]
)
def update_agent_type_summary(agent_stats):
    # Count real active agents by type
    type_counts = {'Pattern Learners': 0, 'Data Miners': 0, 'System': 0}
    for agent_id in agent_stats.keys():
        if 'SwarmBrain' in agent_id:
            type_counts['Pattern Learners'] += 1
        elif any(x in agent_id for x in ['DataMiner', 'RepoScraper', 'LogisticsMiner', 'GovtDataMiner', 'CorpDataMiner']):
            type_counts['Data Miners'] += 1
        else:
            type_counts['System'] += 1

    summary = [
        {'icon': 'fa-brain', 'type': f"Pattern Learners ({type_counts['Pattern Learners']})", 'activity': 'Analyzing data streams, discovering correlations, sharing policies', 'color': COLORS['primary']},
        {'icon': 'fa-search', 'type': f"Data Miners ({type_counts['Data Miners']})", 'activity': 'Collecting data from 5 product moats: Finance, Code, Logistics, Gov, Corp', 'color': COLORS['success']},
        {'icon': 'fa-shield-alt', 'type': 'HAVEN Guardian (1)', 'activity': 'Monitoring system risk, blocking policy contagion at 85% threshold', 'color': COLORS['danger']},
        {'icon': 'fa-cogs', 'type': 'Builder (1)', 'activity': 'Autonomously creating new specialized agents when gaps detected', 'color': '#9333ea'},
        {'icon': 'fa-bolt', 'type': 'Executor (1)', 'activity': 'Executing high-confidence pattern predictions', 'color': '#fbbf24'},
    ]

    items = []
    for s in summary:
        items.append(dbc.Card([
            dbc.CardBody([
                html.Div([
                    html.I(className=f"fas {s['icon']} fa-2x", style={'color': s['color'], 'marginRight': '15px'}),
                    html.Div([
                        html.H6(s['type'], style={'color': COLORS['text'], 'marginBottom': '5px'}),
                        html.P(s['activity'], style={'color': COLORS['text_muted'], 'fontSize': '0.9rem', 'marginBottom': '0'}),
                    ], style={'flex': 1})
                ], style={'display': 'flex', 'alignItems': 'center'})
            ])
        ], style={'backgroundColor': COLORS['background'], 'marginBottom': '10px'}))

    return items

# === MOAT HEALTH CHART ===
@app.callback(
    Output('moat-health-chart', 'figure'),
    [Input('moat-health-store', 'data')]
)
def update_moat_health_chart(moat_health):
    pillars = list(moat_health.keys())
    values = list(moat_health.values())
    colors_list = [COLORS['primary'], COLORS['success'], COLORS['warning'], COLORS['info'], COLORS['corp']]

    fig = go.Figure()
    fig.add_trace(go.Bar(
        x=pillars,
        y=values,
        marker=dict(color=colors_list),
        text=[f"{v:.0f}%" for v in values],
        textposition='outside'
    ))

    fig.update_layout(
        title=dict(text="5-Pillar Moat Health (0-100%)", font=dict(color=COLORS['text'], size=16)),
        plot_bgcolor=COLORS['card'],
        paper_bgcolor=COLORS['card'],
        font=dict(color=COLORS['text_muted']),
        xaxis=dict(gridcolor=COLORS['border']),
        yaxis=dict(title='Health %', gridcolor=COLORS['border'], range=[0, 100]),
        margin=dict(l=40, r=20, t=60, b=80),
        showlegend=False
    )
    return fig

# === MOAT DETAILS (REAL DATA) ===
@app.callback(
    [Output('finance-moat-detail', 'children'),
     Output('code-moat-detail', 'children'),
     Output('logistics-moat-detail', 'children'),
     Output('govt-moat-detail', 'children'),
     Output('corp-moat-detail', 'children')],
    [Input('moat-health-store', 'data'),
     Input('moat-stats-store', 'data')]
)
def update_moat_details(moat_health, moat_stats):
    def create_detail(moat_name):
        health = moat_health.get(moat_name, 100)
        patterns = moat_stats.get(moat_name, {}).get('patterns', 0)
        agents_set = moat_stats.get(moat_name, {}).get('agents', set())
        agents_count = len(agents_set) if isinstance(agents_set, set) else 0

        return html.Div([
            html.P(f"Health: {health:.0f}%", style={'color': COLORS['text'], 'fontSize': '1.2rem', 'fontWeight': '600'}),
            html.P(f"Patterns: {patterns}", style={'color': COLORS['text_muted'], 'fontSize': '0.9rem'}),
            html.P(f"Active Agents: {agents_count}", style={'color': COLORS['text_muted'], 'fontSize': '0.9rem'}),
        ])

    return (
        create_detail('Finance'),
        create_detail('Code Innovation'),
        create_detail('Logistics'),
        create_detail('Government'),
        create_detail('US Corporations')
    )

# === AGENT CARD NAVIGATION ===
@app.callback(
    Output('agent-carousel-index', 'data'),
    [Input('prev-agent-btn', 'n_clicks'),
     Input('next-agent-btn', 'n_clicks')],
    [State('agent-carousel-index', 'data'),
     State('agent-stats-store', 'data')]
)
def navigate_agent_cards(prev_clicks, next_clicks, current_index, agent_stats):
    if not agent_stats:
        return 0

    agent_list = list(agent_stats.keys())
    max_index = len(agent_list) - 1

    ctx = dash.callback_context
    if not ctx.triggered:
        return current_index

    button_id = ctx.triggered[0]['prop_id'].split('.')[0]

    if button_id == 'prev-agent-btn' and prev_clicks:
        current_index = max(0, current_index - 1)
    elif button_id == 'next-agent-btn' and next_clicks:
        current_index = min(max_index, current_index + 1)

    return current_index

# === AGENT CARD DISPLAY ===
@app.callback(
    Output('agent-card-display', 'children'),
    [Input('agent-carousel-index', 'data'),
     Input('agent-stats-store', 'data')]
)
def update_agent_card_display(carousel_index, agent_stats):
    if not agent_stats:
        return html.P("No agents active yet...", style={'color': COLORS['text_muted']})

    agent_list = list(agent_stats.keys())
    if carousel_index >= len(agent_list):
        carousel_index = 0

    agent_id = agent_list[carousel_index]
    agent_info = AGENT_INFO.get(agent_id, {'name': 'Unknown', 'type': 'Unknown', 'color': COLORS['text_muted'], 'icon': 'fa-robot', 'product': 'N/A'})
    agent_data = agent_stats[agent_id]

    # Calculate REAL interestingness
    interestingness = calculate_interestingness(agent_data, agent_stats)

    # Count REAL children
    children_count = len([aid for aid, adata in agent_stats.items()
                         if adata.get('parent') == agent_id])

    # Build stats with REAL data
    stats = {
        'Interestingness Score': f"{interestingness:.1f}/100",
        'Generation': agent_data.get('generation', 0),
        'Patterns Discovered': agent_data.get('patterns_discovered', 0),
        'Policy Shares': agent_data.get('policy_shares', 0),
        'Parent': agent_data.get('parent', 'Genesis'),
        'Children': children_count,
        'Status': agent_data.get('status', 'Active'),
        'Last Active': agent_data.get('last_active', 'Never')
    }

    return html.Div([
        dbc.Row([
            dbc.Col([
                html.Div([
                    html.I(className=f"fas {agent_info['icon']} fa-5x", style={'color': agent_info['color']}),
                ], style={'textAlign': 'center', 'padding': '2rem'}),
            ], width=3),
            dbc.Col([
                html.H3(agent_info['name'], style={'color': agent_info['color'], 'fontWeight': '700'}),
                html.H5(f"ID: {agent_id}", style={'color': COLORS['text_muted']}),
                html.P(f"Type: {agent_info['type']}", style={'color': COLORS['text'], 'fontSize': '1.1rem'}),
                html.P(f"Product Moat: {agent_info['product']}", style={'color': COLORS['text'], 'fontSize': '1.1rem'}),
                html.P(f"Agent {carousel_index + 1} of {len(agent_list)}", style={'color': COLORS['text_muted'], 'fontSize': '0.9rem'}),
            ], width=9),
        ]),
        html.Hr(style={'borderColor': COLORS['border']}),
        dbc.Row([
            dbc.Col([
                html.H5("ðŸ“Š Agent Statistics (Real Data)", style={'color': COLORS['primary'], 'marginBottom': '1rem'}),
                html.Div([
                    html.P([
                        html.Strong(f"{k}: ", style={'color': COLORS['text_muted']}),
                        html.Span(f"{v}", style={'color': COLORS['text']})
                    ], style={'marginBottom': '0.5rem'})
                    for k, v in stats.items()
                ])
            ], width=12),
        ]),
    ])

# === SWARM HEALTH CHART ===
@app.callback(
    Output('swarm-health-chart', 'figure'),
    [Input('swarm-health-store', 'data')]
)
def update_swarm_health_chart(swarm_health):
    history = swarm_health.get('history', [100])

    fig = go.Figure()
    fig.add_trace(go.Scatter(
        y=history,
        mode='lines+markers',
        line=dict(color=COLORS['success'], width=3),
        marker=dict(size=6, color=COLORS['success']),
        fill='tozeroy',
        fillcolor=f'rgba(16, 185, 129, 0.2)',
    ))

    fig.update_layout(
        title=dict(text="Swarm Health Over Time (0-100)", font=dict(color=COLORS['text'], size=16)),
        plot_bgcolor=COLORS['card'],
        paper_bgcolor=COLORS['card'],
        font=dict(color=COLORS['text_muted']),
        xaxis=dict(title='Time', gridcolor=COLORS['border']),
        yaxis=dict(title='Health', gridcolor=COLORS['border'], range=[0, 100]),
        margin=dict(l=40, r=20, t=60, b=40),
    )
    return fig

# === INTERESTINGNESS DISTRIBUTION (REAL DATA) ===
@app.callback(
    Output('interestingness-dist', 'figure'),
    [Input('agent-stats-store', 'data')]
)
def update_interestingness_dist(agent_stats):
    if not agent_stats:
        return go.Figure()

    # Calculate REAL interestingness scores for all agents
    scores = []
    for agent_id, agent_data in agent_stats.items():
        score = calculate_interestingness(agent_data, agent_stats)
        scores.append(score)

    if not scores:
        return go.Figure()

    fig = go.Figure()
    fig.add_trace(go.Histogram(
        x=scores,
        nbinsx=20,
        marker=dict(color=COLORS['primary']),
    ))

    fig.update_layout(
        title=dict(text=f"Interestingness Score Distribution ({len(scores)} Active Agents)", font=dict(color=COLORS['text'], size=16)),
        plot_bgcolor=COLORS['card'],
        paper_bgcolor=COLORS['card'],
        font=dict(color=COLORS['text_muted']),
        xaxis=dict(title='Interestingness Score', gridcolor=COLORS['border']),
        yaxis=dict(title='Number of Agents', gridcolor=COLORS['border']),
        margin=dict(l=40, r=20, t=60, b=40),
    )
    return fig

# === PATTERN TIMELINE ===
@app.callback(
    Output('pattern-timeline', 'figure'),
    [Input('pattern-store', 'data')]
)
def update_pattern_timeline(pattern_data):
    fig = go.Figure()
    fig.add_trace(go.Scatter(
        x=pattern_data.get('times', []),
        y=pattern_data.get('counts', []),
        mode='lines+markers',
        line=dict(color=COLORS['warning'], width=3),
        marker=dict(size=6, color=COLORS['warning']),
        fill='tozeroy',
        fillcolor=f'rgba(245, 158, 11, 0.2)',
        name='Patterns'
    ))

    fig.update_layout(
        title=dict(text="Cumulative Pattern Discovery Timeline", font=dict(color=COLORS['text'], size=16)),
        plot_bgcolor=COLORS['card'],
        paper_bgcolor=COLORS['card'],
        font=dict(color=COLORS['text_muted']),
        xaxis=dict(title='Time', gridcolor=COLORS['border']),
        yaxis=dict(title='Total Patterns Discovered', gridcolor=COLORS['border']),
        margin=dict(l=40, r=20, t=60, b=40),
    )
    return fig

if __name__ == '__main__':
    try:
        app.run(debug=False, port=8055, host='127.0.0.1')
    except Exception as e:
        logging.critical(f"FATAL: {e}")
